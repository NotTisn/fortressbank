_format_version: "3.0"

services:
  # public auth endpoints
  - name: user-auth-service
    url: http://user-service:4000
    routes:
      - name: user-auth-route
        paths:
          - /auth
        strip_path: false

  # protected user endpoints
  - name: user-main-service
    url: http://user-service:4000
    routes:
      - name: user-main-route
        paths:
          - /users
          - /roles
        strip_path: false

  - name: admin-user-service
    url: http://user-service:4000
    routes:
      - name: admin-user-route
        paths:
          - /admin/users
        strip_path: false

  # admin account endpoints (admin role required)
  - name: admin-account-service
    url: http://account-service:4001
    routes:
      - name: admin-account-route
        paths:
          - /admin/accounts
        strip_path: false

  # public account endpoints (no auth required)
  - name: account-public-service
    url: http://account-service:4001
    routes:
      - name: account-public-route
        paths:
          - /accounts/public
        strip_path: false

  # protected account
  - name: account-service
    url: http://account-service:4001
    routes:
      - name: account-service-route
        paths:
          - /accounts
          - /beneficiaries
          - /cards
        strip_path: false

  # protected transaction service
  - name: transaction-service
    url: http://transaction-service:4004
    routes:
      - name: transaction-service-route
        paths:
          - /transactions
        strip_path: false
      - name: transaction-public-route
        paths:
          - /transactions/public
        strip_path: false

  # reference-service
  - name: reference-service
    url: http://reference-service:4003
    routes:
      - name: reference-service-route
        paths:
          - /banks
          - /products
        strip_path: false

  - name: notification-service
    url: http://notification-service:4002
    routes:
      - name: notification-service-route
        paths:
          - /notifications
          - /user-preferences
        strip_path: false

  # risk-engine (Public for testing)
  - name: risk-engine
    url: http://risk-engine:6000/assess
    routes:
      - name: risk-engine-route
        paths:
          - /risk
        strip_path: true

# ============================================================================
# AUTHENTICATION CONFIGURATION
# ============================================================================

plugins:
  # --- Authentication: OpenID Connect via Keycloak ---
  # Single-device enforcement plugin (validates deviceId against Keycloak)
  # This plugin validates that the deviceId in the JWT token matches the X-Device-Id header
  # and that the device has an active session in Keycloak
  #
  # IMPORTANT: Frontend MUST send X-Device-Id header on ALL authenticated requests
  # The deviceId should be stored in localStorage/sessionStorage after login and sent with every API call
  # - name: single-device
  #   config:
  #     keycloak_url: "http://keycloak:8080"
  #     realm: "fortressbank-realm"
  #     client_id: "kong"
  #     client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe"

  # - name: single-device
  #   route: account-service-route
  #   config:
  #     keycloak_url: "http://keycloak:8080"
  #     realm: "fortressbank-realm"
  #     admin_token: "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJyU0FtOGszLUJpa0xsel9TSDNhMDZVZTF2SFFqTHZGZmhwbWt3MXpncjJvIn0.eyJleHAiOjE3Njc1MjI3OTQsImlhdCI6MTc2NzUyMjQ5NCwianRpIjoiZjhhNmIxNzUtZDRmMC00NDIzLWJkNzItNDI0NDlhOWM2NGIxIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4ODg4L3JlYWxtcy9mb3J0cmVzc2JhbmstcmVhbG0iLCJhdWQiOlsicmVhbG0tbWFuYWdlbWVudCIsImFjY291bnQiXSwic3ViIjoiZWUzMmJiZmYtNzRkNi00M2U0LTgwYzUtMzhmZmVhZDNkZGE0IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiYmFja2VuZC1zZXJ2aWNlIiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsImRlZmF1bHQtcm9sZXMtZm9ydHJlc3NiYW5rLXJlYWxtIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJyZWFsbS1tYW5hZ2VtZW50Ijp7InJvbGVzIjpbInF1ZXJ5LXVzZXJzIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsImNsaWVudElkIjoiYmFja2VuZC1zZXJ2aWNlIiwiY2xpZW50SG9zdCI6IjE3Mi4xOC4wLjEiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJzZXJ2aWNlLWFjY291bnQtYmFja2VuZC1zZXJ2aWNlIiwiY2xpZW50QWRkcmVzcyI6IjE3Mi4xOC4wLjEifQ.N0ADCSv_kP1VWQZmNscv2KLthsJB_DjA4NowBLeIViLD6Q2gYhfSWYZfiwdqEIeustKPmkHTnsepeCoFbhiGPZA0HJQq8nqtpJuG_h4UGUBLvXHxB06p5HRNX68Ihtkh5SvPEKJm6-wl3mz8ej8EMFLjfa7K-Bxv_aGnYT0pjBVVf8MzOUqGhkyCxzuCL_EeUn3AoDuvQQSYlr-_DBaWjM-BnYXYSr61nt9zv7MtnWvVHavXAouUtXbtBvUDPr2SXbJ19qbXiWq-OA0rEiYtGPn_pjjFwUh6Ow06lcQ2tg7h2PZcPDN5l1gYR4YBCc6MezpW41D3QfqsNYPBofV1Xw"

  # - name: single-device
  #   route: transaction-service-route
  #   config:
  #     keycloak_url: "http://keycloak:8080"
  #     realm: "fortressbank-realm"
  #     admin_token: "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJyU0FtOGszLUJpa0xsel9TSDNhMDZVZTF2SFFqTHZGZmhwbWt3MXpncjJvIn0.eyJleHAiOjE3Njc1MjI3OTQsImlhdCI6MTc2NzUyMjQ5NCwianRpIjoiZjhhNmIxNzUtZDRmMC00NDIzLWJkNzItNDI0NDlhOWM2NGIxIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4ODg4L3JlYWxtcy9mb3J0cmVzc2JhbmstcmVhbG0iLCJhdWQiOlsicmVhbG0tbWFuYWdlbWVudCIsImFjY291bnQiXSwic3ViIjoiZWUzMmJiZmYtNzRkNi00M2U0LTgwYzUtMzhmZmVhZDNkZGE0IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiYmFja2VuZC1zZXJ2aWNlIiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsImRlZmF1bHQtcm9sZXMtZm9ydHJlc3NiYW5rLXJlYWxtIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJyZWFsbS1tYW5hZ2VtZW50Ijp7InJvbGVzIjpbInF1ZXJ5LXVzZXJzIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsImNsaWVudElkIjoiYmFja2VuZC1zZXJ2aWNlIiwiY2xpZW50SG9zdCI6IjE3Mi4xOC4wLjEiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJzZXJ2aWNlLWFjY291bnQtYmFja2VuZC1zZXJ2aWNlIiwiY2xpZW50QWRkcmVzcyI6IjE3Mi4xOC4wLjEifQ.N0ADCSv_kP1VWQZmNscv2KLthsJB_DjA4NowBLeIViLD6Q2gYhfSWYZfiwdqEIeustKPmkHTnsepeCoFbhiGPZA0HJQq8nqtpJuG_h4UGUBLvXHxB06p5HRNX68Ihtkh5SvPEKJm6-wl3mz8ej8EMFLjfa7K-Bxv_aGnYT0pjBVVf8MzOUqGhkyCxzuCL_EeUn3AoDuvQQSYlr-_DBaWjM-BnYXYSr61nt9zv7MtnWvVHavXAouUtXbtBvUDPr2SXbJ19qbXiWq-OA0rEiYtGPn_pjjFwUh6Ow06lcQ2tg7h2PZcPDN5l1gYR4YBCc6MezpW41D3QfqsNYPBofV1Xw"

  # - name: single-device
  #   route: notification-service-route
  #   config:
  #     keycloak_url: "http://keycloak:8080"
  #     realm: "fortressbank-realm"
  #     admin_token: "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJyU0FtOGszLUJpa0xsel9TSDNhMDZVZTF2SFFqTHZGZmhwbWt3MXpncjJvIn0.eyJleHAiOjE3Njc1MjI3OTQsImlhdCI6MTc2NzUyMjQ5NCwianRpIjoiZjhhNmIxNzUtZDRmMC00NDIzLWJkNzItNDI0NDlhOWM2NGIxIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4ODg4L3JlYWxtcy9mb3J0cmVzc2JhbmstcmVhbG0iLCJhdWQiOlsicmVhbG0tbWFuYWdlbWVudCIsImFjY291bnQiXSwic3ViIjoiZWUzMmJiZmYtNzRkNi00M2U0LTgwYzUtMzhmZmVhZDNkZGE0IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiYmFja2VuZC1zZXJ2aWNlIiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsImRlZmF1bHQtcm9sZXMtZm9ydHJlc3NiYW5rLXJlYWxtIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJyZWFsbS1tYW5hZ2VtZW50Ijp7InJvbGVzIjpbInF1ZXJ5LXVzZXJzIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsImNsaWVudElkIjoiYmFja2VuZC1zZXJ2aWNlIiwiY2xpZW50SG9zdCI6IjE3Mi4xOC4wLjEiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJzZXJ2aWNlLWFjY291bnQtYmFja2VuZC1zZXJ2aWNlIiwiY2xpZW50QWRkcmVzcyI6IjE3Mi4xOC4wLjEifQ.N0ADCSv_kP1VWQZmNscv2KLthsJB_DjA4NowBLeIViLD6Q2gYhfSWYZfiwdqEIeustKPmkHTnsepeCoFbhiGPZA0HJQq8nqtpJuG_h4UGUBLvXHxB06p5HRNX68Ihtkh5SvPEKJm6-wl3mz8ej8EMFLjfa7K-Bxv_aGnYT0pjBVVf8MzOUqGhkyCxzuCL_EeUn3AoDuvQQSYlr-_DBaWjM-BnYXYSr61nt9zv7MtnWvVHavXAouUtXbtBvUDPr2SXbJ19qbXiWq-OA0rEiYtGPn_pjjFwUh6Ow06lcQ2tg7h2PZcPDN5l1gYR4YBCc6MezpW41D3QfqsNYPBofV1Xw"

  # PROTECT user-main-route ONLY
  - name: openid-connect
    route: user-main-route
    config:
      client_id: "kong"
      # client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe" # Dùng đúng secret của bạn
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  - name: openid-connect
    route: admin-user-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe" # Dùng đúng secret của bạn
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  # PROTECT admin account route
  - name: openid-connect
    route: admin-account-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  # PROTECT account service
  - name: openid-connect
    route: account-service-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  - name: openid-connect
    route: transaction-service-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  # Notification service authentication
  - name: openid-connect
    route: notification-service-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  # CORS configuration for development
  - name: cors
    config:
      origins:
        - "http://localhost:5173" # Vite default port
        - "http://localhost:5174" # Alternative port
        - "http://localhost:3000" # Common React dev port
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
        - X-Request-ID
        - Accept
        - Origin
        - X-Device-Id
      exposed_headers:
        - X-RateLimit-Limit-Minute
        - X-RateLimit-Remaining-Minute
      credentials: true
      max_age: 3600

  # GLOBAL rate limit
  # SECURITY NOTE: In production with multiple Kong instances, use policy: redis
  # to share counters across nodes. With policy: local, each node has its own
  # counter which can be exploited by load-balancing across nodes.
  #
  # SECURITY NOTE: limit_by: ip relies on Kong seeing real client IPs.
  # Configure trusted_ips and real_ip_header in kong.conf when behind a proxy.
  - name: rate-limiting
    config:
      minute: 100
      hour: 5000
      limit_by: consumer # Changed from ip - requires authentication first
      policy: local # TODO: Change to redis in production with KONG_REDIS_HOST env var
      fault_tolerant: true
      hide_client_headers: false # Show rate limit headers for debugging

  # ACCOUNT rate limit - stricter for financial operations
  - name: rate-limiting
    service: account-service
    config:
      minute: 60
      hour: 2000
      limit_by: consumer # Rate limit per authenticated user, not per IP
      policy: local
      fault_tolerant: true

  # USER rate limit
  - name: rate-limiting
    service: user-main-service
    config:
      minute: 80
      hour: 3000
      limit_by: consumer
      policy: local
      fault_tolerant: true
